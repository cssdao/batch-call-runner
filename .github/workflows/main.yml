name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Danger.js è‡ªåŠ¨å®¡æŸ¥
  danger:
    name: Danger.js Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run Danger
        run: pnpm danger ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æµ‹è¯•è¦†ç›–ç‡æ£€æŸ¥
  test:
    name: Test Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Run tests
        run: pnpm test -- --coverage || true
      
      - name: Comment coverage on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let message = '## ğŸ“Š æµ‹è¯•è¿è¡Œå®Œæˆ\n\n';
            
            try {
              // è¿™é‡Œå¯ä»¥è¯»å–è¦†ç›–ç‡æŠ¥å‘Šå¹¶æ·»åŠ åˆ°è¯„è®ºä¸­
              message += 'âœ… æµ‹è¯•å·²æ‰§è¡Œï¼Œè¯·æ£€æŸ¥è¦†ç›–ç‡æŠ¥å‘Šã€‚\n';
              message += 'ğŸ’¡ å»ºè®®ï¼šä¿æŒæµ‹è¯•è¦†ç›–ç‡ > 80%';
            } catch (error) {
              message += 'âš ï¸ æ— æ³•è¯»å–æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

  # PR å¤§å°æ ‡ç­¾
  pr-size-labeler:
    name: PR Size Labeler
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Label PR size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/xs'
          xs_max_size: '10'
          s_label: 'size/s'
          s_max_size: '100'
          m_label: 'size/m'
          m_max_size: '400'
          l_label: 'size/l'
          l_max_size: '800'
          xl_label: 'size/xl'
          fail_if_xl: 'false'
